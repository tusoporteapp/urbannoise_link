<!DOCTYPE html>
<html data-bs-theme="light" lang="es-419">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Urban Noise</title>
    <meta name="theme-color" content="#000000">
    <link rel="canonical" href="https://urbannoise.cc/nfc/">
    <meta property="og:url" content="https://urbannoise.cc/nfc/">
    <meta name="twitter:image" content="https://urbannoise.cc/assets/img/logo/LOGO_WEB.png">
    <meta name="twitter:title" content="UrbanNoise">
    <meta name="twitter:card" content="summary">
    <meta property="og:title" content="UrbanNoise">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://urbannoise.cc/assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="../assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="../assets/img/logo/LOGO_WEB.png" media="(prefers-color-scheme: dark)">
    <link rel="icon" type="image/png" sizes="709x709" href="../assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="../assets/img/logo/LOGO_WEB.png" media="(prefers-color-scheme: dark)">
    <link rel="icon" type="image/png" sizes="709x709" href="../assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="../assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="../assets/img/logo/LOGO_WEB.png">
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.min.css">
    <link rel="manifest" href="../manifest.json" crossorigin="use-credentials">
    <link rel="stylesheet" href="../assets/css/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Plus+Jakarta+Sans&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap">
    <link rel="stylesheet" href="../assets/css/swiper-icons.css">
    <link rel="stylesheet" href="../assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="../assets/css/bs-theme-overrides.css">
    <link rel="stylesheet" href="../assets/css/aos.min.css">
    <link rel="stylesheet" href="../assets/css/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/vendor/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/vendor/swiper/swiper-bundle.min.css">
    <link rel="stylesheet" href="../assets/css/css/main.css">
    <link rel="stylesheet" href="../assets/css/Articles-Cards-images.css">
    <link rel="stylesheet" href="../assets/css/Lightbox-Gallery-No-Gutters-baguetteBox.min.css">
    <link rel="stylesheet" href="../assets/css/Navbar-Centered-Brand-Dark-icons.css">
    <link rel="stylesheet" href="../assets/css/tallas.css">
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAj9GLeYHfwhgI_oje28uowybe6hs2d4xw",
    authDomain: "urbannoise-aed65.firebaseapp.com",
    projectId: "urbannoise-aed65",
    storageBucket: "urbannoise-aed65.firebasestorage.app",
    messagingSenderId: "407971144874",
    appId: "1:407971144874:web:65d027fa5bb68b81fa9cd3",
    measurementId: "G-2C4W1QJLF1"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

<!-- Manifiesto PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
</head>

<body class="index-page" style="background: #000000;">
    <nav class="navbar navbar-expand-md sticky-top py-3" data-bs-theme="dark" style="background: var(--background-color);">
        <div class="container"><a class="navbar-brand d-flex align-items-center" href="#"><img class="img-fluid" src="../assets/img/logo/lSOTIPO%20BLANCO%20WEB.png" width="34" height="32"></a>
            <div><a class="btn btn-primary" role="button" style="background: rgba(13,110,253,0);border-style: none;font-size: 20px;" href="https://www.instagram.com/urban_noise_/"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-instagram">
                        <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334"></path>
                    </svg></a><a class="btn btn-primary" role="button" style="background: rgba(13,110,253,0);border-style: none;font-size: 20px;" href="https://www.tiktok.com/@urban_noise"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-tiktok">
                        <path d="M9 0h1.98c.144.715.54 1.617 1.235 2.512C12.895 3.389 13.797 4 15 4v2c-1.753 0-3.07-.814-4-1.829V11a5 5 0 1 1-5-5v2a3 3 0 1 0 3 3z"></path>
                    </svg></a><a class="btn btn-primary" role="button" style="border-style: none;background: rgba(114,153,210,0);font-size: 20px;" href="https://wa.me/573108720491?text=Hola%2C%20vi%20tu%20contenido%20y%20me%20interesa%20saber%20m%C3%A1s."><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-whatsapp">
                        <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"></path>
                    </svg></a></div>
        </div>
    </nav>
    <header class="d-flex align-items-center visually-hidden header sticky-top" id="header">
        <div class="container-fluid d-flex justify-content-between align-items-center position-relative"><a class="d-flex align-items-center me-auto logo me-xl-0" href="index.html"><img src="../assets/img/logo/Contornos_UrbanNoise-06.png"></a>
            <nav id="navmenu" class="navmenu"><i class="d-xl-none mobile-nav-toggle bi bi-list"></i></nav>
            <div class="header-social-links"><a href="#" class="twitter"><i class="bi bi-twitter-x"></i></a><a href="#" class="facebook"><i class="bi bi-facebook"></i></a><a href="#" class="instagram"><i class="bi bi-instagram"></i></a><a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a></div>
        </div>
    </header>
    <main class="main">
        <section id="hero" class="hero section" style="background: linear-gradient(black 6%, rgba(255,255,255,0)), url(&quot;../assets/img/fondo/pexels-evgeniy-grozev-814830.webp&quot;) center / cover;height: 100vh;">
            <div class="container" style="margin-top: -150px;">
                <div class="row gy-4 row-cols-1 row-cols-md-2 row-cols-xl-3">
                    <div class="col-12" data-aos="zoom-in-up"><a data-bs-target="#offcanvas-1" data-bs-toggle="offcanvas">
                            <div class="card">
                                <div class="card-body p-4" style="background: linear-gradient(-94deg, rgba(0,0,0,0) 0%, var(--bs-gray-300) 65%), url(&quot;../assets/img/catalogo/CABALLERO/texturizado/ref.conj.niños/Diapositiva4.jpg&quot;) center / cover no-repeat, #ffffff;border-radius: 7px;">
                                    <div class="d-flex"><img class="rounded-circle flex-shrink-0 me-3 fit-cover" width="50" height="50" src="../assets/img/logo/LOGO_WEB.png" style="background: #ffffff;">
                                        <div>
                                            <p class="fw-bolder mb-0" style="color: var(--nav-mobile-background-color);font-weight: bold;">JUEGA Y GANA</p>
                                            <p class="text-muted mb-0" style="font-size: 14px;"><strong>Juego Interactivo para ganar prendas y códigos de descuentos en urbannoise.</strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a></div>
                    <div class="col-12" data-aos="zoom-in-up"><a>
                            <div class="card">
                                <div class="card-body p-4" style="background: linear-gradient(-94deg, rgba(0,0,0,0) 0%, var(--bs-gray-300) 65%), url(&quot;../assets/img/catalogo/CABALLERO/acidwash/ref.polaroid/Diapositiva4.webp&quot;) center / cover, #ffffff;border-radius: 7px;">
                                    <div class="d-flex"><img class="rounded-circle flex-shrink-0 me-3 fit-cover" width="50" height="50" src="../assets/img/logo/LOGO_WEB.png" style="background: #ffffff;">
                                        <div>
                                            <p class="fw-bold mb-0" style="color: var(--nav-mobile-background-color);font-weight: bold;">SITIO WEB</p>
                                            <p class="text-muted mb-0" style="font-size: 14px;"><strong>Visita nuestra pagina web.</strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a></div>
                    <div class="col-12" data-aos="zoom-in-up"><a>
                            <div class="card">
                                <div class="card-body p-4" style="background: linear-gradient(-94deg, rgba(0,0,0,0) 0%, var(--bs-gray-300) 65%), url(&quot;../assets/img/fondo/pexels-cottonbro-6615596.webp&quot;) center / cover no-repeat, #ffffff;border-radius: 7px;">
                                    <div class="d-flex"><img class="rounded-circle flex-shrink-0 me-3 fit-cover" width="50" height="50" src="../assets/img/logo/LOGO_WEB.png" style="background: #ffffff;">
                                        <div>
                                            <p class="fw-bold mb-0" style="color: var(--nav-mobile-background-color);">PROMOCIONES</p>
                                            <p class="text-muted mb-0" style="font-size: 14px;"><strong>Mira nuestras promociones que tenemos para ti el día de hoy.</strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a></div>
                    <div class="col-12" data-aos="zoom-in-up"><a>
                            <div class="card">
                                <div class="card-body p-4" style="background: linear-gradient(-94deg, rgba(0,0,0,0) 0%, var(--bs-gray-300) 65%), url(&quot;../assets/img/fondo/pexels-godisable-jacob-226636-914662-1.webp&quot;) center / cover repeat-x, #ffffff;border-radius: 7px;">
                                    <div class="d-flex"><img class="rounded-circle flex-shrink-0 me-3 fit-cover" width="50" height="50" src="../assets/img/logo/LOGO_WEB.png" style="background: #ffffff;">
                                        <div>
                                            <p class="fw-bold mb-0" style="color: var(--nav-mobile-background-color);">LO NUEVO</p>
                                            <p class="text-muted mb-0" style="font-size: 14px;"><strong>Enterate de lo nuevo de UrbanNoise antes que cualquiera.</strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a></div>
                </div>
            </div>
        </section>
    </main><a class="d-flex justify-content-center align-items-center scroll-top" href="#" id="scroll-top"><i class="bi bi-arrow-up-short"></i></a>
    <div class="modal fade" role="dialog" tabindex="-1" id="modal-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="ratio ratio-16x9" style="height: 100vh;"><iframe src="https://www.urbannoise.co/"></iframe></div>
                <div class="modal-header" style="background: var(--background-color);border-style: none;"><button class="btn-close btn-close-white" type="button" aria-label="Close" data-bs-dismiss="modal"></button></div>
            </div>
        </div>
    </div>
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvas-1" data-bs-theme="dark">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Juega y Gana</h5><button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="offcanvas" data-bs-target="#offcanvas-1"></button>
        </div><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Culebrita Urbannoise: Fondo Negro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            touch-action: none;
            background-color: #000000; /* Fondo 100% NEGRO */
            color: #ffffff; /* Texto principal blanco por defecto */
        }
        #gameCanvas {
            background-color: #1a1a1a; /* Un gris muy oscuro para el canvas, casi negro */
            border-radius: 0.375rem;
            display: block;
            border: 1px solid #444; /* Borde sutil para el canvas si es necesario */
        }
        .touch-button {
            user-select: none;
            min-width: 60px;
            padding: 0.5rem 0.75rem;
            background-color: #333; /* Botones más oscuros */
            border-color: #555;
            color: #fff;
        }
        .touch-button:hover, .touch-button:active {
            background-color: #555;
            border-color: #777;
        }
        html, body {
            height: 100%;
            margin: 0;
        }
        #gameContainer {
            max-width: 520px; 
            width: 100%; 
            padding: 10px;
            box-sizing: border-box;
        }
        #controlsContainer {
            max-width: 300px;
            margin-top: 15px;
        }
        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
            min-height: 100vh;
            padding: 1rem;
            overflow-y: auto; 
        }
        #gameOverModal .modal-content, #startScreen {
            background-color: #1c1c1c; /* Un gris oscuro para los contenedores principales */
            color: #f8f9fa; /* Texto casi blanco */
            border: 1px solid #495057;
            border-radius: 0.5rem;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.1); /* Sombra sutil amarilla */
        }
        #startScreen {
            padding: 1.5rem;
            width: 100%;
            display: flex;
            flex-direction: column; 
            align-items: center; 
        }
        #gameOverModal .modal-header { 
            border-bottom: 1px solid #495057; 
            color: #ffc107; /* Amarillo para el título del modal */
        }
        #gameOverModal .modal-title { font-weight: bold; }
        #gameOverModal .modal-footer { 
            border-top: 1px solid #495057; 
            justify-content: center; 
        }
        #gameOverModal .btn-primary, #startGameButton { 
            background-color: #ffc107; /* Amarillo para botones principales */
            border-color: #ffc107;
            color: #000; /* Texto oscuro para contraste en botón amarillo */
            font-weight: bold;
        }
        #gameOverModal .btn-primary:hover, #startGameButton:hover { 
            background-color: #e0a800;
            border-color: #d39e00;
            color: #000;
        }

        #instructions h5, #discountInfoContainer h5, #weeklyChallengeStatusContainer h5, #redeemDiscountContainer h5, #highScoresContainer h5 {
            color: #ffc107; 
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        #instructions ul, #highScoresList { padding-left: 0; }
        #instructions ul li, #highScoresList li { margin-bottom: 0.5rem; list-style-type: none; color: #e9ecef; }
        
        .food-example, .obstacle-example, .powerup-example, .discount-u-example {
            display: inline-block; width: 1em; height: 1em;
            border-radius: 3px; vertical-align: middle; margin: 0 2px;
            text-align: center; font-weight: bold; line-height: 1em;
            font-size: 0.9em; 
            border: 1px solid rgba(255,255,255,0.3); 
        }
        .food-example { background-color: #e74c3c; color: white; } 
        .obstacle-example { background-color: #555; color: #ccc; } 
        .powerup-shield { background-color: #3498db; color: white;} 
        .powerup-slow { background-color: #f1c40f; color: #2c3e50;}   
        .powerup-multiplier { background-color: #e67e22; color: white;} 
        .powerup-scissors { background-color: #bdc3c7; color: #2c3e50;} 
        .discount-u-example { background-color: #8e44ad; color: white;} 
        
        #activePowerUpDisplay {
            position: absolute; top: 5px; right: 5px;
            background-color: rgba(255,255,255,0.15); color: #fff;
            padding: 3px 8px; border-radius: 5px; font-size: 0.8em;
        }
        #gameStatsDisplay {
            display: flex;
            justify-content: space-around; 
            align-items: center;
            width: 100%;
            padding: 0.3rem 0;
            margin-bottom: 0.5rem; 
            background-color: rgba(255,255,255,0.05); 
            border-radius: 0.25rem;
            color: #f8f9fa; 
        }
        #gameStatsDisplay .stat-item {
            font-size: 0.9em;
            font-weight: bold;
            padding: 0.2rem 0.5rem;
        }
        .urbannoise-purple { color: #9b59b6; } 
        .points-green { color: #2ecc71; } 
        .level-blue { color: #3498db; } 

        #highScoresList .list-group-item {
            background-color: transparent; border-color: rgba(255,255,255,0.1);
            color: #e9ecef; padding: 0.5rem 0.75rem;
        }
        #instructions { width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem; margin-top: 1rem; }
        
        #timedMessageDisplay {
            position: fixed;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            background-color: #ffc107; 
            color: #000;
            padding: 10px 15px;
            border-radius: 0.375rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none; 
            min-width: 300px;
            max-width: 90%;
            font-size: 0.9rem;
            border: 1px solid #e0a800;
        }
        #weeklyChallengeStatusContainer {
            border: 1px dashed #ffc107;
            padding: 0.5rem;
            margin-bottom: 1rem;
            background-color: rgba(255, 193, 7, 0.1);
        }
        #redeemDiscountContainer .btn-outline-light { 
            color: #ffc107;
            border-color: #ffc107;
        }
         #redeemDiscountContainer .btn-outline-light:hover {
            background-color: #ffc107;
            color: #000;
        }
        #redeemDiscountContainer .btn-outline-light:disabled {
            color: #6c757d;
            border-color: #6c757d;
        }
        #startScreen > h1.display-5 {
            color: #ffc107; 
            text-shadow: 0 0 5px rgba(255, 193, 7, 0.5); 
        }
        #gameArea .display-6 {
            color: #ffc107; 
        }
    </style>
</head>
<body class="select-none">

    <div class="game-wrapper">
        <div id="gameContainer">

            <div id="startScreen" class="text-center">
                <h1 class="display-5 mb-3 fw-bold">Culebrita Urbannoise</h1> 
                <!-- Botón de Iniciar Juego movido aquí -->
                <button id="startGameButton" class="btn btn-lg px-5 mb-3">Iniciar Juego</button>
                
                <p class="mb-3 text-white-50">¡Juega y Acumula Descuentos!</p>
                
                <div id="discountInfoContainer" class="w-100 mb-3 p-2 rounded" style="background-color: rgba(111, 66, 193, 0.2);">
                    <h5><i class="fas fa-percentage me-2 text-light"></i>Tu Descuento Urbannoise: 
                        <span id="startScreenDiscountTotal" class="badge bg-purple text-white fs-5">0.0%</span>
                    </h5>
                </div>

                <div id="redeemDiscountContainer" class="w-100 mb-3 p-2 rounded border border-secondary">
                    <h5><i class="fas fa-gift me-2 text-success"></i>Canjear Descuento</h5>
                    <div id="redeemButtons">
                        <p class="small text-muted">Acumula descuentos para activar opciones de canje.</p>
                    </div>
                </div>

                <div id="weeklyChallengeStatusContainer" class="w-100">
                    <!-- El estado del reto semanal se cargará aquí -->
                </div>

                <div id="highScoresContainer" class="w-100 mb-3">
                    <h5><i class="fas fa-trophy me-2 text-warning"></i>Puntuaciones Máximas</h5>
                    <ul id="highScoresList" class="list-group list-group-flush text-start">
                        <li class="list-group-item">Cargando...</li>
                    </ul>
                </div>
                                
                <div id="instructions" class="text-start small">
                    <p class="mt-2 text-center fst-italic">En juego: <strong class="urbannoise-purple">D:</strong> Descuento, <strong class="points-green">P:</strong> Puntos, <strong class="level-blue">N:</strong> Nivel.</p>
                    <h5 class="text-center">Controles:</h5>
                    <ul>
                        <li><i class="fas fa-arrows-alt me-2 text-info"></i>Teclado: Flechas.</li>
                        <li><i class="fas fa-hand-pointer me-2 text-info"></i>Móvil: Desliza o usa botones.</li>
                    </ul>
                    <h5 class="text-center">Objetivo y Descuentos:</h5>
                    <ul>
                        <li><i class="fas fa-apple-alt me-2 text-danger"></i>Come <span class="food-example"></span> para crecer y subir de nivel.</li>
                        <li><i class="fas fa-tachometer-alt me-2 text-light"></i>Cada <strong>5 puntos</strong> subes de nivel ¡y el juego se acelera!</li>
                        <li><i class="fas fa-tags me-2" style="color: #6f42c1;"></i>Potenciador Urbannoise <span class="discount-u-example">U</span>: Da 0.1% o 0.5% de descuento.</li>
                        <li><i class="fas fa-calendar-week me-2 text-info"></i>**Reto Semanal:** Juega continuamente para ganar descuentos automáticos (20min=+2%, 40min=+4%, 1hora=+5%). ¡Disponible una vez por semana! El tiempo de juego se acumula entre partidas rápidas, pero se reinicia tras 3 min de inactividad en el menú.</li>
                        <li><i class="fas fa-ban me-2 text-secondary"></i>Evita chocar con paredes, tu cola, y obstáculos <span class="obstacle-example"></span>.</li>
                    </ul>
                    <h5 class="text-center">Otros Potenciadores:</h5>
                    <ul>
                        <li><i class="fas fa-shield-alt me-2 text-primary"></i>Escudo <span class="powerup-example powerup-shield">S</span>: Invencibilidad.</li>
                        <li><i class="fas fa-clock me-2 text-warning"></i>Reloj <span class="powerup-example powerup-slow">R</span>: Juego lento.</li>
                        <li><i class="fas fa-star me-2 text-orange"></i>Estrella <span class="powerup-example powerup-multiplier">X</span>: Puntos x2.</li>
                        <li><i class="fas fa-cut me-2 text-light"></i>Tijeras <span class="powerup-example powerup-scissors">T</span>: Cola corta.</li>
                    </ul>
                </div>
            </div>

            <div id="gameArea" class="w-100" style="display: none; position: relative;">
                <div id="activePowerUpDisplay" style="display: none;"></div>
                <div class="text-center"> 
                    <h1 class="display-6 mb-1">Culebrita</h1>
                </div>
                <div id="gameStatsDisplay">
                    <span id="inGameDiscountDisplay" class="stat-item urbannoise-purple">D: 0.0%</span>
                    <span id="inGameScoreDisplay" class="stat-item points-green">P: 0</span>
                    <span id="inGameLevelDisplay" class="stat-item level-blue">N: 1</span>
                </div>
                <canvas id="gameCanvas" class="mx-auto"></canvas>
                <div id="controlsContainer" class="mx-auto mt-3">
                    <div class="row justify-content-center gx-2">
                        <div class="col-4"></div><div class="col-4 d-grid"><button id="upButton" class="btn btn-secondary touch-button">↑</button></div><div class="col-4"></div>
                    </div>
                    <div class="row justify-content-center mt-2 gx-2">
                        <div class="col-4 d-grid"><button id="leftButton" class="btn btn-secondary touch-button">←</button></div>
                        <div class="col-4 d-grid"><button id="downButton" class="btn btn-secondary touch-button">↓</button></div>
                        <div class="col-4 d-grid"><button id="rightButton" class="btn btn-secondary touch-button">→</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="gameOverModal" tabindex="-1" aria-labelledby="gameOverModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="gameOverModalLabel">¡Juego Terminado!</h5></div>
                <div class="modal-body text-center">
                    <p class="fs-5">Nivel Alcanzado: <span id="finalLevel" class="fw-bold">1</span></p>
                    <p class="fs-4">Puntuación Final: <span id="finalScore" class="fw-bold">0</span></p>
                    <p class="fs-5 mt-3">Descuento Urbannoise Total: <strong id="finalDiscountTotal" class="text-success">0.0%</strong></p>
                </div>
                <div class="modal-footer">
                    <button id="returnToMenuButton" type="button" class="btn btn-primary">Volver al Menú</button>
                </div>
            </div>
        </div>
    </div>
    <div id="timedMessageDisplay" role="alert"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const inGameDiscountDisplay = document.getElementById('inGameDiscountDisplay');
        const inGameScoreDisplay = document.getElementById('inGameScoreDisplay');
        const inGameLevelDisplay = document.getElementById('inGameLevelDisplay');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const activePowerUpDisplay = document.getElementById('activePowerUpDisplay');
        const startScreenDiscountTotalDisplay = document.getElementById('startScreenDiscountTotal'); 
        const weeklyChallengeStatusContainer = document.getElementById('weeklyChallengeStatusContainer');
        const redeemButtonsContainer = document.getElementById('redeemButtons');
        
        const finalScoreDisplay = document.getElementById('finalScore');
        const finalLevelDisplay = document.getElementById('finalLevel'); 
        const finalDiscountTotalDisplay = document.getElementById('finalDiscountTotal'); 
        const returnToMenuButton = document.getElementById('returnToMenuButton');
        const startScreen = document.getElementById('startScreen');
        const gameArea = document.getElementById('gameArea');
        const startGameButton = document.getElementById('startGameButton');
        const highScoresListUL = document.getElementById('highScoresList'); 
        const timedMessageDisplay = document.getElementById('timedMessageDisplay');
        let timedMessageTimeoutId = null;
        
        let gameOverModal; 

        let gridSize = 20;
        let tileSize;
        let snake, food, dx, dy, score, gameLoopTimeoutId, gameIsOver = true; 
        let obstacles = [];
        let powerUp = null; 
        let activePowerUp = null; 
        let accumulatedDiscount = 0;
        
        const SNAKE_COLOR = '#2ecc71'; 
        const FOOD_COLOR = '#e74c3c'; 
        const OBSTACLE_COLOR = '#7f8c8d'; 
        const URBANOISE_DISCOUNT_COLOR = '#9b59b6'; 
        const POWERUP_COLORS = { 
            shield: '#3498db', slow: '#f1c40f', multiplier: '#e67e22', scissors: '#bdc3c7', 
            urbannoiseDiscount: URBANOISE_DISCOUNT_COLOR,
        };
        const POWERUP_TYPES = ['shield', 'slow', 'multiplier', 'scissors', 'urbannoiseDiscount', 'urbannoiseDiscount']; 
        const POWERUP_SPAWN_CHANCE = 0.18; 
        const SHIELD_DURATION = 5000; 
        const SLOW_DURATION = 8000; 
        let baseGameSpeed = 160; 
        let currentSpeedSetting = baseGameSpeed;

        let currentLevel = 1;
        const POINTS_PER_LEVEL = 5; 
        const MAX_LEVEL = 15;
        const SPEED_INCREASE_PER_LEVEL = 7; 

        const MAX_HIGH_SCORES = 5;
        const URBANOISE_STORAGE_KEY = 'urbannoiseSnakeDiscount_v2_3_timer_persist_HS_black_ordered'; 
        const HIGH_SCORES_STORAGE_KEY = 'urbannoiseSnakeHighScores_v2_3_timer_persist_HS_black_ordered'; 
        const WEEKLY_CHALLENGE_STORAGE_KEY = 'urbannoiseWeeklyChallengeWeek_v2_3_timer_persist_HS_black_ordered'; 

        let sessionPlaytime = 0; 
        let weeklyTimeChallengeAvailable = true; 
        let sessionReached20Min = false; 
        let sessionReached40Min = false; 
        let sessionReached1Hour = false; 
        let lastActivityTimestamp = Date.now();
        let inactivityCheckIntervalId = null;
        const INACTIVITY_TIMEOUT_MS = 3 * 60 * 1000; 

        const WHATSAPP_NUMBER = '573108720491'; 
        const REDEEM_OPTIONS = [5, 10, 15, 20]; 

        const TWENTY_MINUTES_MS = 20 * 60 * 1000;
        const FORTY_MINUTES_MS = 40 * 60 * 1000;
        const ONE_HOUR_MS = 60 * 60 * 1000;

        const upButton = document.getElementById('upButton');
        const downButton = document.getElementById('downButton');
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');
        let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
        const swipeThreshold = 50;

        let soundsReady = false;
        let moveSynth, eatSynth, gameOverSynth, backgroundMusicSeq, powerUpSpawnSynth, powerUpCollectSynth, shieldActivateSynth, shieldDeactivateSynth, levelUpSynth, discountCollectSynth, weeklyDiscountSound;
        let backgroundMusicSynth;

        async function initializeSounds() {
            if (soundsReady) return;
            try { await Tone.start(); } 
            catch (e) { console.warn("Tone.start() no se pudo iniciar automáticamente.", e); return; }
            
            const defaultVolume = -10; const musicVolume = -24;
            moveSynth = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 }, volume: defaultVolume - 2 }).toDestination();
            eatSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 }, volume: defaultVolume }).toDestination();
            gameOverSynth = new Tone.AMSynth({ harmonicity: 1.5, envelope: { attack: 0.05, decay: 0.5, sustain: 0, release: 0.5 }, modulationEnvelope: { attack: 0.1, decay: 0.3, sustain: 0, release: 0.5 }, volume: defaultVolume }).toDestination();
            powerUpSpawnSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 }, volume: defaultVolume - 2 }).toDestination();
            powerUpCollectSynth = new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.4 }, volume: defaultVolume }).toDestination();
            shieldActivateSynth = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }, volume: defaultVolume - 5 }).toDestination();
            shieldDeactivateSynth = new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.15, sustain: 0, release: 0.1 }, volume: defaultVolume - 5 }).toDestination();
            levelUpSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.1, release: 0.5 }, volume: defaultVolume - 3 }).toDestination();
            discountCollectSynth = new Tone.Synth({ oscillator: { type: "sine", frequency: "A5" }, envelope: { attack: 0.02, decay: 0.2, sustain: 0.1, release: 0.3 }, volume: defaultVolume }).toDestination();
            weeklyDiscountSound = new Tone.Synth({ oscillator: { type: "triangle", frequency: "E6" }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.2, release: 0.8 }, volume: defaultVolume + 3 }).toDestination();
            backgroundMusicSynth = new Tone.MonoSynth({ oscillator: { type: "pulse", width: 0.6 }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 }, filterEnvelope: { attack: 0.01, decay: 0.05, sustain: 0.1, release: 0.3, baseFrequency: 200, octaves: 2.5 }, volume: musicVolume }).toDestination();
            const musicPattern = ["C4","E4","G4","E4","C4","E4","G4","E4","D4","F4","A4","F4","D4","F4","A4","F4","E4","G4","B4","G4","E4","G4","B4","G4","C4",null,"A3",null,"G3",null,"F3",null];
            backgroundMusicSeq = new Tone.Sequence((time, note) => { if (note) backgroundMusicSynth.triggerAttackRelease(note, "16n", time); }, musicPattern, "8n").set({ loop: true });
            Tone.Transport.bpm.value = 130; 
            soundsReady = true;
        }
        
        async function attemptSoundInitialization() { 
            if (!soundsReady) {
                try { await initializeSounds(); } 
                catch(e) { console.error("Error al inicializar sonidos en attempt:", e); return; }
            }
            if (soundsReady && !gameIsOver && Tone.Transport.state !== "started") { 
                Tone.Transport.start();
                if (backgroundMusicSeq.state !== "started") backgroundMusicSeq.start(0);
            }
        }

        function playSound(synth, note, duration) { if (!soundsReady || !synth) return; synth.triggerAttackRelease(note, duration, Tone.now()); }
        function showTimedMessage(htmlMessage, duration = 5000) { if (timedMessageTimeoutId) clearTimeout(timedMessageTimeoutId); timedMessageDisplay.innerHTML = htmlMessage; timedMessageDisplay.style.display = 'block'; timedMessageTimeoutId = setTimeout(() => { timedMessageDisplay.style.display = 'none'; }, duration); }
        function hideTimedMessage() { if (timedMessageTimeoutId) clearTimeout(timedMessageTimeoutId); timedMessageDisplay.style.display = 'none'; }

        function loadAccumulatedDiscount() { const savedDiscount = localStorage.getItem(URBANOISE_STORAGE_KEY); accumulatedDiscount = savedDiscount ? parseFloat(savedDiscount) : 0; updateAllUIDisplays(); }
        function saveAccumulatedDiscount() { localStorage.setItem(URBANOISE_STORAGE_KEY, accumulatedDiscount.toFixed(2)); }
        
        function updateAllUIDisplays() {
            const discountText = `D: ${accumulatedDiscount.toFixed(1)}%`; const scoreText = `P: ${score}`; const levelText = `N: ${currentLevel}`;
            if (inGameDiscountDisplay) inGameDiscountDisplay.textContent = discountText;
            if (inGameScoreDisplay) inGameScoreDisplay.textContent = scoreText;
            if (inGameLevelDisplay) inGameLevelDisplay.textContent = levelText;
            if (startScreenDiscountTotalDisplay) startScreenDiscountTotalDisplay.textContent = accumulatedDiscount.toFixed(1) + "%";
            if (finalDiscountTotalDisplay) finalDiscountTotalDisplay.textContent = accumulatedDiscount.toFixed(1) + "%";
            if (finalScoreDisplay) finalScoreDisplay.textContent = score;
            if (finalLevelDisplay) finalLevelDisplay.textContent = currentLevel;
            updateRedeemButtons();
        }

        function updateRedeemButtons() {
            redeemButtonsContainer.innerHTML = ''; 
            let hasRedeemableOption = false;
            REDEEM_OPTIONS.forEach(option => {
                const button = document.createElement('button');
                button.classList.add('btn', 'btn-outline-light', 'btn-sm');
                button.textContent = `Canjear ${option}%`;
                button.dataset.redeemValue = option;
                if (accumulatedDiscount >= option) {
                    button.disabled = false;
                    button.addEventListener('click', handleRedeemDiscount);
                    hasRedeemableOption = true;
                } else {
                    button.disabled = true;
                }
                redeemButtonsContainer.appendChild(button);
            });
            if (!hasRedeemableOption) {
                 redeemButtonsContainer.innerHTML = '<p class="small text-muted">Acumula más descuento para canjear.</p>';
            }
        }

        function handleRedeemDiscount(event) {
            const valueToRedeem = parseFloat(event.target.dataset.redeemValue);
            if (accumulatedDiscount >= valueToRedeem) {
                accumulatedDiscount -= valueToRedeem;
                saveAccumulatedDiscount();
                updateAllUIDisplays();

                const message = `Hola, me gustaria cangear ${valueToRedeem}% de descuento me ayudan. (Descuento acumulado restante: ${accumulatedDiscount.toFixed(1)}%)`;
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
                
                window.open(whatsappUrl, '_blank');
                showTimedMessage(`¡Se abrirá WhatsApp para enviar tu solicitud de canje de ${valueToRedeem}%!`, 7000);
            } else {
                showTimedMessage("No tienes suficiente descuento para esta opción.", 3000);
            }
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return d.getUTCFullYear() + '-' + weekNo; 
        }

        function checkWeeklyChallengeStatus() {
            const currentWeek = getWeekNumber(new Date());
            const lastChallengeWeek = localStorage.getItem(WEEKLY_CHALLENGE_STORAGE_KEY);
            if (lastChallengeWeek === currentWeek) {
                weeklyTimeChallengeAvailable = false;
                weeklyChallengeStatusContainer.innerHTML = `<h5 class="text-warning"><i class="fas fa-calendar-check me-2"></i>Reto Semanal de Tiempo</h5><p class="small text-muted mb-0">Ya completado esta semana. ¡Vuelve la próxima!</p>`;
            } else {
                weeklyTimeChallengeAvailable = true;
                weeklyChallengeStatusContainer.innerHTML = `<h5 class="text-warning"><i class="fas fa-calendar-alt me-2"></i>Reto Semanal de Tiempo</h5><p class="small text-success mb-0">¡DISPONIBLE! Juega para ganar descuentos automáticos por tiempo.</p>`;
            }
        }
        function markWeeklyChallengeCompletedForWeek() {
            const currentWeek = getWeekNumber(new Date());
            localStorage.setItem(WEEKLY_CHALLENGE_STORAGE_KEY, currentWeek);
            weeklyTimeChallengeAvailable = false; 
            weeklyChallengeStatusContainer.innerHTML = `<h5 class="text-warning"><i class="fas fa-calendar-check me-2"></i>Reto Semanal de Tiempo</h5><p class="small text-muted mb-0">¡Reto semanal completado! Gracias por jugar.</p>`;
        }
        
        function checkInactivity() {
            if (gameIsOver && Date.now() - lastActivityTimestamp > INACTIVITY_TIMEOUT_MS) { 
                console.log("Inactivity timeout. Resetting session playtime for weekly challenge.");
                sessionPlaytime = 0;
                sessionReached20Min = false;
                sessionReached40Min = false;
                sessionReached1Hour = false;
                lastActivityTimestamp = Date.now(); 
            }
        }

        function startInactivityCheck() {
            if (inactivityCheckIntervalId) clearInterval(inactivityCheckIntervalId); 
            inactivityCheckIntervalId = setInterval(checkInactivity, 5000); 
        }

        function stopInactivityCheck() {
            if (inactivityCheckIntervalId) clearInterval(inactivityCheckIntervalId);
            inactivityCheckIntervalId = null;
        }
        
        function getHighScores() { 
            const scoresJSON = localStorage.getItem(HIGH_SCORES_STORAGE_KEY); 
            return scoresJSON ? JSON.parse(scoresJSON) : []; 
        }
        function saveHighScore(newScore, levelAchieved) { 
            let scores = getHighScores(); 
            scores.push({ score: newScore, level: levelAchieved, date: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) }); 
            scores.sort((a, b) => b.score - a.score || b.level - a.level); 
            scores = scores.slice(0, MAX_HIGH_SCORES); 
            localStorage.setItem(HIGH_SCORES_STORAGE_KEY, JSON.stringify(scores)); 
        }
        function displayHighScores() { 
            const scores = getHighScores();
            const highScoresListULElement = document.getElementById('highScoresList'); 
            if (!highScoresListULElement) return; 

            highScoresListULElement.innerHTML = ''; 
            if (scores.length === 0) {
                highScoresListULElement.innerHTML = '<li class="list-group-item text-muted">Aún no hay puntuaciones.</li>';
            } else {
                scores.forEach((s, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center small';
                    li.innerHTML = `<span class="fw-bold">${index + 1}. ${s.score} Pts</span> <span class="text-white-50">(Niv ${s.level} - ${s.date})</span>`;
                    highScoresListULElement.appendChild(li);
                });
            }
        }
        
        function calculateSpeedForLevel(level) { return Math.max(50, baseGameSpeed - (level - 1) * SPEED_INCREASE_PER_LEVEL); }
        
        function generateObstacles(level = 1) { obstacles = []; const numObstacles = Math.min(3 + Math.floor(level / 3), 8); for(let i=0; i < numObstacles; i++) { let obsX, obsY, validObsPos = false; while(!validObsPos) { obsX = Math.floor(Math.random() * gridSize); obsY = Math.floor(Math.random() * gridSize); validObsPos = true; if ( (Math.abs(obsX - Math.floor(gridSize/2)) <= 3 && Math.abs(obsY - Math.floor(gridSize/2)) <= 3) || obstacles.some(o => o.x === obsX && o.y === obsY) || (snake && snake.some(seg => seg.x === obsX && seg.y === obsY)) ) { validObsPos = false; } } obstacles.push({x: obsX, y: obsY}); } }
        
        function placeItem(isPowerUp = false) { 
            let itemX, itemY, type; let validPosition = false;
            let attempts = 0; 
            while(!validPosition && attempts < gridSize * gridSize) {
                itemX = Math.floor(Math.random() * gridSize); itemY = Math.floor(Math.random() * gridSize);
                validPosition = true; attempts++;
                if (snake) for (const segment of snake) if (itemX === segment.x && itemY === segment.y) { validPosition = false; break; }
                if (!validPosition) continue;
                for (const obs of obstacles) if (itemX === obs.x && itemY === obs.y) { validPosition = false; break; }
                if (!validPosition) continue;
                if (food && itemX === food.x && itemY === food.y) validPosition = false;
                if (powerUp && itemX === powerUp.x && itemY === powerUp.y) validPosition = false;
            }
            if (!validPosition) { food = null; powerUp = null; return; }

            if (isPowerUp) {
                type = POWERUP_TYPES[Math.floor(Math.random() * POWERUP_TYPES.length)];
                let discountValue = 0;
                if (type === 'urbannoiseDiscount') { 
                    if (currentLevel <= 7) discountValue = 0.1;
                    else discountValue = Math.random() < 0.7 ? 0.1 : 0.5; 
                }
                powerUp = { x: itemX, y: itemY, type: type, discount: discountValue }; 
                food = null; 
                playSound(powerUpSpawnSynth, "C5", "8n");
            } else {
                food = { x: itemX, y: itemY }; powerUp = null; 
            }
        }

        function resizeCanvas() { 
            if (!gameArea || gameArea.style.display === 'none') return;
            const gameContainerForSizing = document.getElementById('gameContainer'); const containerWidth = gameContainerForSizing.clientWidth;
            const gameStatsElement = document.getElementById('gameStatsDisplay'); const gameTitleElement = gameArea.querySelector('.display-6');
            const controlsElement = document.getElementById('controlsContainer');
            const statsHeight = gameStatsElement ? gameStatsElement.offsetHeight : 30;
            const titleHeight = gameTitleElement ? gameTitleElement.offsetHeight : 50;
            const controlsHeight = controlsElement ? controlsElement.offsetHeight : 100;
            const availableHeight = window.innerHeight - titleHeight - statsHeight - controlsHeight - 80; 
            const size = Math.min(containerWidth - 20, availableHeight); 
            const calculatedWidth = Math.floor(size / gridSize) * gridSize;
            canvas.width = Math.max(gridSize * 5, calculatedWidth); 
            canvas.height = canvas.width; 
            if(canvas.width > 0) tileSize = canvas.width / gridSize; 
            else tileSize = 0; 
            if (!gameIsOver && tileSize && tileSize > 0) drawGame(); 
        }

        async function initializeGame() {
            stopInactivityCheck(); 
            lastActivityTimestamp = Date.now(); 

            gameIsOver = false;
            await attemptSoundInitialization();
            snake = [{ x: Math.floor(gridSize / 2), y: Math.floor(gridSize / 2) }];
            dx = 1; dy = 0; 
            score = 0; 
            currentLevel = 1; 
            
            if (sessionPlaytime === 0) { 
                sessionReached20Min = false;
                sessionReached40Min = false;
                sessionReached1Hour = false;
            }
            hideTimedMessage();

            updateAllUIDisplays(); 
            currentSpeedSetting = calculateSpeedForLevel(currentLevel);
            deactivateCurrentPowerUp(true); 
            powerUp = null; food = null; 
            generateObstacles(currentLevel);
            placeItem(); 
            if (gameLoopTimeoutId) clearTimeout(gameLoopTimeoutId);
            lastRafTime = performance.now(); 
            requestAnimationFrame(gameLoop); 
        }

        function activatePowerUp(collectedPowerUp) { 
            deactivateCurrentPowerUp(false); 
            if (collectedPowerUp.type === 'urbannoiseDiscount') { 
                accumulatedDiscount += collectedPowerUp.discount;
                saveAccumulatedDiscount();
                updateAllUIDisplays();
                playSound(discountCollectSynth, "C6", "8n"); 
                activePowerUp = null; 
                updateActivePowerUpDisplay(); 
                return; 
            }
            activePowerUp = { type: collectedPowerUp.type, remainingTime: 0, usesLeft: 0 };
            playSound(powerUpCollectSynth, "A4", "4n"); let displayText = "";
            switch(collectedPowerUp.type) {
                case 'shield': activePowerUp.remainingTime = SHIELD_DURATION; playSound(shieldActivateSynth); displayText = "Escudo!"; break;
                case 'slow': activePowerUp.remainingTime = SLOW_DURATION; activePowerUp.originalSpeed = currentSpeedSetting; currentSpeedSetting = calculateSpeedForLevel(currentLevel) + 60; displayText = "Lento!"; break; 
                case 'multiplier': activePowerUp.usesLeft = 1; displayText = "Puntos x2!"; break;
                case 'scissors': if (snake.length > 3) { const segmentsToRemove = Math.min(snake.length - 3, 3); snake.splice(snake.length - segmentsToRemove, segmentsToRemove); } displayText = "Cola Corta!"; setTimeout(() => { if(activePowerUp && activePowerUp.type === 'scissors') activePowerUp = null; updateActivePowerUpDisplay(); }, 1500); break;
            }
            updateActivePowerUpDisplay();
        }
        function deactivateCurrentPowerUp(isReset = false) { 
            if (!activePowerUp) return;
            if (activePowerUp.type === 'shield' && !isReset) playSound(shieldDeactivateSynth);
            if (activePowerUp.type === 'slow') currentSpeedSetting = calculateSpeedForLevel(currentLevel); 
            activePowerUp = null; updateActivePowerUpDisplay();
        }
        function updatePowerUpTimers(elapsedTime) { 
             if (activePowerUp && typeof activePowerUp.remainingTime === 'number' && activePowerUp.remainingTime > 0) {
                activePowerUp.remainingTime -= elapsedTime;
                if (activePowerUp.remainingTime <= 0) deactivateCurrentPowerUp(false);
                updateActivePowerUpDisplay();
            }
        }
        function updateActivePowerUpDisplay() { 
            if (activePowerUp) {
                let text = "";
                switch(activePowerUp.type) {
                    case 'shield': text = `Escudo: ${Math.ceil(activePowerUp.remainingTime/1000)}s`; break;
                    case 'slow': text = `Lento: ${Math.ceil(activePowerUp.remainingTime/1000)}s`; break;
                    case 'multiplier': text = `Puntos x2: ${activePowerUp.usesLeft} uso(s)`; break;
                    case 'scissors': text = `Cola Corta!`; break; 
                }
                activePowerUpDisplay.textContent = text; activePowerUpDisplay.style.display = text ? 'block' : 'none';
            } else { activePowerUpDisplay.style.display = 'none'; }
        }

        function drawGame() { 
            if (!canvas || !ctx || gameIsOver || !tileSize || tileSize <= 0) {
                return; 
            }
            ctx.fillStyle = '#343a40'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = OBSTACLE_COLOR; obstacles.forEach(obs => ctx.fillRect(obs.x * tileSize, obs.y * tileSize, tileSize -1, tileSize -1));
            if (food) {
                ctx.fillStyle = FOOD_COLOR; ctx.fillRect(food.x * tileSize, food.y * tileSize, tileSize - 1, tileSize - 1);
            } else if (powerUp) { 
                ctx.fillStyle = POWERUP_COLORS[powerUp.type] || '#FFFFFF'; 
                ctx.fillRect(powerUp.x * tileSize, powerUp.y * tileSize, tileSize - 1, tileSize - 1);
                ctx.fillStyle = (powerUp.type.includes('Discount') || powerUp.type === 'slow' || powerUp.type === 'shield' || powerUp.type === 'scissors') ? '#212529' : '#FFFFFF'; 
                let P_char = '?';
                let fontSize = `bold ${tileSize*0.65}px Arial`;
                if(powerUp.type === 'shield') P_char = 'S'; 
                else if (powerUp.type === 'slow') P_char = 'R'; 
                else if (powerUp.type === 'multiplier') P_char = 'X'; 
                else if (powerUp.type === 'scissors') P_char = 'T'; 
                else if (powerUp.type === 'urbannoiseDiscount') P_char = 'U';
                ctx.font = fontSize; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(P_char, powerUp.x * tileSize + tileSize/2, powerUp.y * tileSize + tileSize/2 + 1);
            }
            let currentSnakeColor = SNAKE_COLOR; if (activePowerUp && activePowerUp.type === 'shield') currentSnakeColor = POWERUP_COLORS.shield;
            ctx.fillStyle = currentSnakeColor; snake.forEach(segment => ctx.fillRect(segment.x * tileSize, segment.y * tileSize, tileSize - 1, tileSize - 1));
        }

        function updateGame() { 
            if (gameIsOver || !snake || snake.length === 0) return;
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            const shieldIsActive = activePowerUp && activePowerUp.type === 'shield';
            if (head.x < 0 || head.x >= gridSize || head.y < 0 || head.y >= gridSize) { triggerGameOver(); return; }
            if (!shieldIsActive) {
                for (let i = 1; i < snake.length; i++) if (head.x === snake[i].x && head.y === snake[i].y) { triggerGameOver(); return; }
                for (const obs of obstacles) if (head.x === obs.x && head.y === obs.y) { triggerGameOver(); return; }
            }
            snake.unshift(head); 
            if (food && head.x === food.x && head.y === food.y) {
                let pointsEarned = 1;
                if (activePowerUp && activePowerUp.type === 'multiplier' && activePowerUp.usesLeft > 0) {
                    pointsEarned = 2; activePowerUp.usesLeft--;
                    if (activePowerUp.usesLeft === 0) { setTimeout(() => { if(activePowerUp && activePowerUp.type === 'multiplier') { activePowerUp = null; updateActivePowerUpDisplay();}}, 100); }
                }
                score += pointsEarned; 
                playSound(eatSynth, "G5", "16n");
                if (score > 0 && Math.floor((score - pointsEarned) / POINTS_PER_LEVEL) < Math.floor(score / POINTS_PER_LEVEL) && currentLevel < MAX_LEVEL) {
                    currentLevel++; playSound(levelUpSynth, "C6", "8n");
                    currentSpeedSetting = calculateSpeedForLevel(currentLevel); generateObstacles(currentLevel); 
                }
                updateAllUIDisplays(); 
                if (powerUp === null && Math.random() < POWERUP_SPAWN_CHANCE) placeItem(true); else placeItem(false);
            } 
            else if (powerUp && head.x === powerUp.x && head.y === powerUp.y) { 
                activatePowerUp(powerUp); 
                powerUp = null; 
                placeItem(false); 
            }
            else { snake.pop(); }
        }

        function triggerGameOver() {
            console.log("triggerGameOver called"); 
            gameIsOver = true;
            stopInactivityCheck(); 
            playSound(gameOverSynth, "C3", "8n");
            if (soundsReady && Tone.Transport.state === "started") { Tone.Transport.stop(); Tone.Transport.position = 0; }
            deactivateCurrentPowerUp(true); 
            saveHighScore(score, currentLevel); 
            updateAllUIDisplays(); 
            if(gameOverModal) {
                console.log("gameOverModal object exists, attempting to show."); 
                gameOverModal.show();
            } else {
                console.error("gameOverModal no está inicializado al llamar a triggerGameOver.");
            }
        }

        let lastRafTime = 0; 
        let gameTickTimeoutId = null; 

        function gameLoop(timestamp) { 
            if (gameIsOver) {
                if (gameTickTimeoutId) clearTimeout(gameTickTimeoutId); gameTickTimeoutId = null;
                return;
            }
            const deltaTime = timestamp - lastRafTime; lastRafTime = timestamp;
            if (!gameIsOver) sessionPlaytime += deltaTime; 
            updatePowerUpTimers(deltaTime); 

            if (weeklyTimeChallengeAvailable) { 
                if (!sessionReached20Min && sessionPlaytime >= TWENTY_MINUTES_MS) {
                    accumulatedDiscount += 2.0; saveAccumulatedDiscount(); updateAllUIDisplays();
                    showTimedMessage("¡Reto Semanal (20 Min)! <strong>+2%</strong> Dcto.");
                    playSound(weeklyDiscountSound, "D5", "4n");
                    sessionReached20Min = true; 
                    markWeeklyChallengeCompletedForWeek(); 
                }
                if (weeklyTimeChallengeAvailable && !sessionReached40Min && sessionPlaytime >= FORTY_MINUTES_MS) { 
                    accumulatedDiscount += 4.0; saveAccumulatedDiscount(); updateAllUIDisplays();
                    showTimedMessage("¡Reto Semanal (40 Min)! <strong>+4%</strong> Dcto. Adicional.");
                    playSound(weeklyDiscountSound, "F5", "4n");
                    sessionReached40Min = true;
                }
                if (weeklyTimeChallengeAvailable && !sessionReached1Hour && sessionPlaytime >= ONE_HOUR_MS) {
                    accumulatedDiscount += 5.0; saveAccumulatedDiscount(); updateAllUIDisplays();
                    showTimedMessage("¡Reto Semanal (1 HORA)! <strong>+5%</strong> Dcto. Adicional. ¡Genial!");
                    playSound(weeklyDiscountSound, "A5", "2n");
                    sessionReached1Hour = true;
                }
            }

            if (gameTickTimeoutId) clearTimeout(gameTickTimeoutId); 
            const loopDelay = Math.max(50, currentSpeedSetting - Math.min(score * 2, 80)); 
            gameTickTimeoutId = setTimeout(() => {
                if (!gameIsOver) { updateGame(); drawGame(); requestAnimationFrame(gameLoop); }
            }, loopDelay);
        }
        
        function handleDirectionChange(newDx, newDy) { if (!gameIsOver) { if ((dx !== -newDx || dy !== -newDy) && (dx !== newDx || dy !== newDy) ) { dx = newDx; dy = newDy; playSound(moveSynth, "C5", "32n");} else if ( (dx === 0 && dy === 0) && (newDx !==0 || newDy !==0 ) ) { dx = newDx; dy = newDy; playSound(moveSynth, "C5", "32n");}}}
        function handleKeyDown(e) { if (gameIsOver && e.key !== 'Enter' && e.key !== ' ') return; switch (e.key) { case 'ArrowUp': if (dy === 0) handleDirectionChange(0, -1); break; case 'ArrowDown': if (dy === 0) handleDirectionChange(0, 1); break; case 'ArrowLeft': if (dx === 0) handleDirectionChange(-1, 0); break; case 'ArrowRight': if (dx === 0) handleDirectionChange(1, 0); break; }}
        upButton.addEventListener('click', () => { if (dy === 0 && !gameIsOver) handleDirectionChange(0, -1); });
        downButton.addEventListener('click', () => { if (dy === 0 && !gameIsOver) handleDirectionChange(0, 1); });
        leftButton.addEventListener('click', () => { if (dx === 0 && !gameIsOver) handleDirectionChange(-1, 0); });
        rightButton.addEventListener('click', () => { if (dx === 0 && !gameIsOver) handleDirectionChange(1, 0); });
        canvas.addEventListener('touchstart', (e) => { if (gameIsOver) return; e.preventDefault(); touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY;}, { passive: false });
        canvas.addEventListener('touchend', (e) => { if (gameIsOver) return; e.preventDefault(); touchEndX = e.changedTouches[0].screenX; touchEndY = e.changedTouches[0].screenY; handleSwipe();}, { passive: false });
        function handleSwipe() { if (gameIsOver) return; const deltaX = touchEndX - touchStartX; const deltaY = touchEndY - touchStartY; if (Math.abs(deltaX) > Math.abs(deltaY)) { if (Math.abs(deltaX) > swipeThreshold) { if (deltaX > 0 && dx === 0) handleDirectionChange(1, 0); else if (deltaX < 0 && dx === 0) handleDirectionChange(-1, 0); }} else { if (Math.abs(deltaY) > swipeThreshold) { if (deltaY > 0 && dy === 0) handleDirectionChange(0, 1); else if (deltaY < 0 && dy === 0) handleDirectionChange(0, -1); }}}
        
        startGameButton.addEventListener('click', async () => {
            stopInactivityCheck(); 
            lastActivityTimestamp = Date.now(); 
            
            checkWeeklyChallengeStatus(); 
            startScreen.style.display = 'none'; gameArea.style.display = 'block';
            resizeCanvas(); 
            await initializeGame(); 
            lastRafTime = performance.now(); 
        });

        returnToMenuButton.addEventListener('click', () => { 
            if(gameOverModal) gameOverModal.hide(); 
            else console.error("gameOverModal no está inicializado al intentar ocultarlo en returnToMenu.");

            gameArea.style.display = 'none'; startScreen.style.display = 'flex'; 
            loadAccumulatedDiscount(); checkWeeklyChallengeStatus(); 
            displayHighScores(); 
            gameIsOver = true; 
            lastActivityTimestamp = Date.now(); 
            startInactivityCheck(); 

            if (soundsReady && Tone.Transport.state === "started") { Tone.Transport.stop(); Tone.Transport.position = 0; }
            deactivateCurrentPowerUp(true); 
            if (gameTickTimeoutId) { clearTimeout(gameTickTimeoutId); gameTickTimeoutId = null; } 
            hideTimedMessage(); 
        });
        
        document.addEventListener('keydown', handleKeyDown);
        window.addEventListener('resize', () => { if (gameArea.style.display !== 'none') resizeCanvas(); });

        document.addEventListener('DOMContentLoaded', () => {
            const gameOverModalElement = document.getElementById('gameOverModal');
            if (gameOverModalElement) {
                 gameOverModal = new bootstrap.Modal(gameOverModalElement);
            } else {
                console.error("Game Over Modal element not found on DOMContentLoaded!");
            }

            startScreen.style.display = 'flex'; gameArea.style.display = 'none';
            loadAccumulatedDiscount(); 
            checkWeeklyChallengeStatus(); 
            displayHighScores(); 
            lastActivityTimestamp = Date.now(); 
            startInactivityCheck(); 
        });
    </script>
</body>
</html>
    </div>
    <nav class="navbar navbar-expand-md fixed-bottom py-3" style="background: var(--background-color);border-style: none;">
        <div class="container">
            <div class="d-flex justify-content-center align-items-center" style="width: 100%;text-align: center;"><button class="btn btn-primary" id="btnCompartirWhatsapp" type="button" style="background: var(--background-color);border-style: none;width: 100%;"><span><strong>COMPARTIR CONTENIDO</strong></span></button></div>
        </div>
    </nav>
    <script src="../assets/js/jquery.min.js"></script>
    <script src="../assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="../assets/js/aos.min.js"></script>
    <script src="../assets/js/bs-init.js"></script>
    <script src="../assets/js/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/vendor/php-email-form/validate.js"></script>
    <script src="../assets/js/vendor/aos/aos.js"></script>
    <script src="../assets/js/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="../assets/js/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="../assets/js/js/main.js"></script>
    <script src="../assets/js/blogger.js"></script>
    <script src="../assets/js/compartir.js"></script>
    <script src="../assets/js/Lightbox-Gallery-No-Gutters-baguetteBox.min.js"></script>
    <script src="../assets/js/Lightbox-Gallery-No-Gutters-Lightbox-Gallery.js"></script>
    <script src="../assets/js/pagina.js"></script>
    <script src="../assets/js/search.js"></script>
    <script src="../assets/js/WhatsApp%20Camisetas.js"></script>
</body>

</html>