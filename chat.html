<!DOCTYPE html>
<html data-bs-theme="light" lang="es-419">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Urban Noise</title>
    <meta name="theme-color" content="#000000">
    <link rel="canonical" href="https://urbannoise.cc/chat.html">
    <meta property="og:url" content="https://urbannoise.cc/chat.html">
    <meta name="twitter:image" content="https://urbannoise.cc/assets/img/logo/LOGO_WEB.png">
    <meta name="twitter:title" content="UrbanNoise">
    <meta name="twitter:card" content="summary">
    <meta property="og:type" content="article">
    <meta property="og:title" content="UrbanNoise">
    <meta property="og:image" content="https://urbannoise.cc/assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="assets/img/logo/LOGO_WEB.png" media="(prefers-color-scheme: dark)">
    <link rel="icon" type="image/png" sizes="709x709" href="assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="assets/img/logo/LOGO_WEB.png" media="(prefers-color-scheme: dark)">
    <link rel="icon" type="image/png" sizes="709x709" href="assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="assets/img/logo/LOGO_WEB.png">
    <link rel="icon" type="image/png" sizes="709x709" href="assets/img/logo/LOGO_WEB.png">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <link rel="stylesheet" href="assets/css/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Plus+Jakarta+Sans&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap">
    <link rel="stylesheet" href="assets/css/swiper-icons.css">
    <link rel="stylesheet" href="assets/css/bs-theme-overrides.css">
    <link rel="stylesheet" href="assets/css/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/vendor/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/vendor/swiper/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/css/main.css">
    <link rel="stylesheet" href="assets/css/Articles-Cards-images.css">
    <link rel="stylesheet" href="assets/css/Lightbox-Gallery-No-Gutters-baguetteBox.min.css">
    <link rel="stylesheet" href="assets/css/Navbar-Centered-Brand-Dark-icons.css">
    <link rel="stylesheet" href="assets/css/tallas.css">
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAj9GLeYHfwhgI_oje28uowybe6hs2d4xw",
    authDomain: "urbannoise-aed65.firebaseapp.com",
    projectId: "urbannoise-aed65",
    storageBucket: "urbannoise-aed65.firebasestorage.app",
    messagingSenderId: "407971144874",
    appId: "1:407971144874:web:65d027fa5bb68b81fa9cd3",
    measurementId: "G-2C4W1QJLF1"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

<!-- Manifiesto PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
</head>

<body><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URBAN - Asistente Virtual</title>
    <!-- Incluyendo Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Incluyendo la fuente Inter de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para la aplicación */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; 
        }
        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 100%;
            border: none;
            border-radius: 0;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .card-body p {
            white-space: pre-wrap;
            word-break: break-word;
        }
        .message-buttons .btn {
            margin-top: 8px;
            margin-right: 8px;
        }
        .iframe-container {
            margin-top: 1rem;
            border: 1px solid #dee2e6;
            border-radius: .5rem;
            overflow: hidden;
        }
        .iframe-header {
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
        }
        .iframe-container iframe {
            width: 100%;
            height: 550px;
            border: none;
        }
        .loading-indicator {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        .typing-indicator span {
            height: 10px;
            width: 10px;
            background-color: #6c757d;
            display: inline-block;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        @media (min-width: 768px) {
            body { display: flex; align-items: center; justify-content: center; }
            .chat-container {
                height: 85vh;
                max-height: 800px;
                max-width: 700px;
                border: 1px solid #dee2e6;
                border-radius: .5rem;
                box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
            }
        }
        
        @media (max-width: 767px) {
            .card-body p, #user-input::placeholder, #user-input {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>

    <div class="chat-container d-flex flex-column">
        <!-- Cabecera del Chat -->
        <div class="card-header text-white d-flex justify-content-between align-items-center p-3" style="background-color: #000000;">
            <h1 class="h5 mb-0 fw-bold">URBAN | Comunidad Noise</h1>
            <img src="https://urbannoise.cc/assets/img/logo/lSOTIPO%20BLANCO%20WEB.png" alt="Logo Urban Noise" style="width: 40px; height: 40px; object-fit: contain;">
        </div>

        <!-- Área de Mensajes -->
        <div id="chat-messages" class="card-body p-3 chat-messages">
            <!-- Los mensajes se agregarán aquí dinámicamente -->
        </div>

        <!-- Indicador de "Escribiendo..." -->
        <div id="typing-indicator" class="p-3 d-none">
             <div class="d-flex justify-content-start">
                <div class="card bg-white border"><div class="card-body p-3"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>
            </div>
        </div>

        <!-- Formulario de Entrada -->
        <div class="card-footer p-3 bg-white border-top">
            <form id="chat-form" class="d-flex align-items-center gap-2">
                <input type="text" id="user-input" placeholder="Escribe tu mensaje aquí..." autocomplete="off" class="form-control form-control-lg rounded-pill">
                <button type="submit" id="send-button" class="btn btn-dark btn-lg rounded-circle d-flex align-items-center justify-content-center" style="background-color: #000000; border-color: #000000; width: 50px; height: 50px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Incluyendo Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        
        let userName = ''; 
        let chatHistory = []; 

        const system_prompt = `
            Eres URBAN. Tu objetivo es conectar a los clientes con la marca de forma personal, rápida y útil.
            REGLA PRINCIPAL: Usa el nombre del cliente ({userName}) cuando sea apropiado. Tus respuestas deben ser cortas. Utiliza el formato de botones [Texto](URL).
            REGLA DE BOTONES: Para enlaces a categorías de productos, USA SIEMPRE el prefijo 'category:'. Ejemplo: [Ver Buzos](category:https://...). Para todo lo demás (WhatsApp, Instagram, web principal), NO uses el prefijo.
            
            DEBES RESPONDER EXCLUSIVamente CON BASE EN LA SIGUIENTE INFORMACIÓN. Si se te consulta algo fuera, tu ÚNICA respuesta debe ser: "¡Buena pregunta, {userName}! Para darte ese dato exacto, un agente te ayudará mejor. [Hablar con un agente](whatsapp:+573108720491)"

            **1. Saludos y Conversación General:**
            - Al inicio, después de que el usuario da su nombre, salúdalo así: "¡Un gusto, {userName}! Ya eres de la casa. ¿Qué quieres ver hoy? [Novedades en la Web](https://www.urbannoise.co) o [Lo último en Redes](https://www.instagram.com/urban_noise_/)"
            - Si el usuario dice que quiere comprar algo de inmediato (ej. "quiero una camiseta"), omite el saludo de bienvenida y ve directo a la sección 2.
            - Si te saluda de nuevo ("hola", "buenas"), responde amistosamente: "¡Qué más, {userName}! Dime qué necesitas."

            **2. Web y Colecciones:**
            - **Pregunta General (sin género):** Si preguntan por "ropa", "novedades", "camisetas", "pantalones", etc., sin especificar género, PRIMERO pregunta: "{userName}, ¿buscas para hombre o para mujer?".
            - **Categorías Hombre:** Si preguntan por "hombre", responde: "¡Claro, {userName}! Aquí tienes las categorías de hombre: [Acid Wash](category:https://www.urbannoise.co/hombre3/camiseta-oversize8/acid-wash/) [Burda Clásica](category:https://www.urbannoise.co/hombre3/camiseta-oversize8/burda-clasica/) [Galleta](category:https://www.urbannoise.co/hombre3/camiseta-oversize8/galleta/) [Esqueletos](category:https://www.urbannoise.co/hombre3/esqueletos/) [Buzos](category:https://www.urbannoise.co/hombre3/buzos-y-sacos/) [Conjuntos](category:https://www.urbannoise.co/hombre3/conjuntos1/) [Bermudas](category:https://www.urbannoise.co/hombre3/bermudas/)"
            - **Categorías Mujer:** Si preguntan por "mujer", responde: "¡Por supuesto, {userName}! Para mujer tenemos: [Buzos y Sacos](category:https://www.urbannoise.co/mujer1/buzos-y-sacos1/) [Conjuntos](category:https://www.urbannoise.co/mujer1/conjuntos/) [Pantalones](category:https://www.urbannoise.co/mujer1/pantalon/)"

            **3. MANEJO DE KEYWORDS DE CATEGORÍAS:**
            - Si el usuario escribe una palabra clave de una categoría, responde directamente con el botón y una pregunta de seguimiento.
            - "acid wash", "acid": "¡Listo, {userName}! Aquí tienes la colección. [Ver Acid Wash](category:https://www.urbannoise.co/hombre3/camiseta-oversize8/acid-wash/) ¿Te interesa ver algo más?"
            - "buzo hombre", "saco hombre": "Aquí están los buzos para hombre. [Ver Buzos y Sacos](category:https://www.urbannoise.co/hombre3/buzos-y-sacos/) ¿Te ayudo con otra cosa, {userName}?"
            - "buzo mujer", "saco mujer": "Los buzos y sacos para mujer. [Ver Buzos y Sacos](category:https://www.urbannoise.co/mujer1/buzos-y-sacos1/) ¿Qué más te gustaría ver?"
        `;
        
        async function callGemini(history) {
            const payload = { contents: history };
            const apiKey = "AIzaSyAPPw3GgpKEnEVkvNuCnWOcoM433yXQLhQ";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Error en la API: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                return result.candidates[0].content.parts[0].text;
            }
            return "No pude procesar la respuesta.";
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = userInput.value.trim();
            if (!userMessage) return;
            
            addMessage(userMessage, 'user');
            userInput.value = '';

            userInput.disabled = true;
            sendButton.disabled = true;
            typingIndicator.classList.remove('d-none');
            chatMessages.appendChild(typingIndicator);
            scrollToBottom();

            try {
                let botMessage;
                
                // CAMBIO: Lógica mejorada para la primera interacción
                if (!userName) {
                    const nameExtractionPrompt = `Analiza la siguiente frase y extrae SOLAMENTE el nombre de pila de la persona. Si no hay un nombre claro, responde con la palabra 'Invitado'. La frase es: "${userMessage}"`;
                    userName = await callGemini([{ role: "user", parts: [{ text: nameExtractionPrompt }] }]);
                    
                    // Ahora que tenemos el nombre, dejamos que el sistema principal decida la mejor respuesta.
                    chatHistory = [ { "role": "user", "parts": [{ "text": system_prompt.replace(/{userName}/g, userName) }] } ];
                }
                
                chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                botMessage = await callGemini(chatHistory);
                
                chatHistory.push({ role: "model", parts: [{ text: botMessage }] });
                
                typingIndicator.classList.add('d-none');
                addMessage(botMessage.replace(/{userName}/g, userName), 'bot');

            } catch (error) {
                console.error("Error:", error);
                typingIndicator.classList.add('d-none');
                addMessage(`Error técnico. Intenta de nuevo más tarde.`, 'bot-error');
            } finally {
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        });

        function addMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `d-flex mb-3 ${sender === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
            
            const buttonRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
            let messageText = text.replace(/<|>/g, '');
            let buttonsHTML = '';
            
            messageText = messageText.replace(buttonRegex, (match, buttonText, url) => {
                let buttonClass = 'btn btn-sm';
                let finalUrl = url;

                if (url.startsWith('category:')) {
                    const categoryUrl = url.substring('category:'.length);
                    buttonsHTML += `<button type="button" class="${buttonClass} btn-outline-dark" onclick="showCategoryInIframe('${categoryUrl}', this, '${buttonText}')">${buttonText}</button> `;
                } else {
                    buttonClass += url.startsWith('whatsapp:') ? ' text-white' : ' btn-outline-dark';
                    let style = url.startsWith('whatsapp:') ? 'background-color: #000000; border-color: #000000;' : '';
                    if (url.startsWith('whatsapp:')) {
                         const phone = url.split(':')[1].replace(/\D/g, '');
                         const message = encodeURIComponent("Hola Urban Noise, te contacto desde el asistente URBAN.");
                         finalUrl = `https://wa.me/${phone}?text=${message}`;
                    } else if (!url.startsWith('http')) {
                         finalUrl = 'https://' + url;
                    }
                    buttonsHTML += `<a href="${finalUrl}" target="_blank" class="${buttonClass}" style="${style}">${buttonText}</a> `;
                }
                return '';
            }).trim();
            
            const sanitizedText = messageText;
            let html = '';
            const messageContentHTML = `<p class="mb-0">${sanitizedText}</p><div class="message-buttons">${buttonsHTML}</div>`;

            if (sender === 'user') {
                html = `<div class="card text-white border-0" style="background-color: #000000; max-width: 80%;"><div class="card-body p-3 rounded-3"><p class="fw-bold mb-1">${userName || 'Tú'}</p><p class="mb-0">${text}</p></div></div>`;
            } else {
                let cardClass = sender === 'bot-error' ? 'bg-danger-subtle text-danger-emphasis' : 'bg-white border';
                html = `<div class="card ${cardClass}" style="max-width: 80%;"><div class="card-body p-3 rounded-3"><p class="fw-bold mb-1">URBAN</p>${messageContentHTML}</div></div>`;
            }

            messageWrapper.innerHTML = html;
            chatMessages.appendChild(messageWrapper);
            scrollToBottom();
        }

        function showCategoryInIframe(url, buttonElement, title) {
            const parentMessage = buttonElement.closest('.card-body');
            parentMessage.querySelectorAll('button, a').forEach(btn => btn.disabled = true);
            
            const iframeContainer = document.createElement('div');
            iframeContainer.className = 'iframe-container';
            
            const iframeHeader = document.createElement('div');
            iframeHeader.className = 'iframe-header';
            iframeHeader.innerHTML = `<span class="fw-bold small">${title}</span><button type="button" class="btn-close" aria-label="Close"></button>`;
            iframeContainer.appendChild(iframeHeader);
            
            iframeHeader.querySelector('.btn-close').onclick = () => {
                iframeContainer.remove();
                 parentMessage.querySelectorAll('button, a').forEach(btn => btn.disabled = false);
            };

            const loadingIndicator = document.createElement('p');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.textContent = 'Cargando categoría...';
            iframeContainer.appendChild(loadingIndicator);
            
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.onload = () => { loadingIndicator.style.display = 'none'; };
            
            iframeContainer.appendChild(iframe);
            parentMessage.appendChild(iframeContainer);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        window.addEventListener('load', () => {
             addMessage("¡Hey! Soy URBAN, tu asistente personal de Urban Noise. Para empezar, ¿cómo te llamas?", 'bot');
             userInput.focus();
        });

    </script>
</body>
</html>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendor/php-email-form/validate.js"></script>
    <script src="assets/js/vendor/aos/aos.js"></script>
    <script src="assets/js/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/js/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/js/js/main.js"></script>
    <script src="assets/js/atras.js"></script>
    <script src="assets/js/blogger.js"></script>
    <script src="assets/js/compartir.js"></script>
    <script src="assets/js/Lightbox-Gallery-No-Gutters-baguetteBox.min.js"></script>
    <script src="assets/js/Lightbox-Gallery-No-Gutters-Lightbox-Gallery.js"></script>
    <script src="assets/js/pagina.js"></script>
    <script src="assets/js/search.js"></script>
    <script src="assets/js/WhatsApp%20Camisetas.js"></script>
</body>

</html>